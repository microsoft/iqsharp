name: $(Build.Major).$(Build.Minor).$(DayOfMonth)$(rev:rr)

trigger: none

pr:
- main
- feature/*
- features/*
- release/*

schedules:
- cron: "0 9 * * Sat"
  displayName: 'Build for Component Governance'
  branches:
    include:
    - main
  always: true

variables:
  Build.Major: 0
  Build.Minor: 18
  Drops.Dir: $(Build.ArtifactStagingDirectory)/drops
  IQSharp.Hosting.Env: 'build-agent-iqsharp'
  agent.preferPowerShellOnContainers: false

jobs:
- job: "prototype_linux"
  variables:
    CondaEnvironmentName: conda_env
    CondaPath:  /miniconda/bin/
  pool: 
    vmImage: 'ubuntu-18.04'
  container: 'mcr.microsoft.com/quantum/linux-selfcontained:latest'
  steps:
  - task: UseDotNet@2
    displayName: 'Use .NET SDK'
    inputs:
      packageType: sdk
      useGlobalJson: true

  - task: UsePythonVersion@0
    inputs:
      versionSpec: 3.9
    displayName: 'Use Python 3.9'

  - pwsh: |
      $env:PATH="$env:CondaPath;$env:PATH"
      $CondaLocation=$(Get-Command conda | Select-Object -ExpandProperty Source)
      $CondaShellHook="(`& `$(Get-Command conda | Select-Object -ExpandProperty Source) 'shell.powershell' 'hook') | Out-String | Invoke-Expression"
      
      "##vso[task.setvariable variable=CondaEnvironmentName]conda_env" | Write-Host
      "##vso[task.setvariable variable=CondaLocation]$CondaLocation" | Write-Host
      "##vso[task.setvariable variable=CondaShellHook]$CondaShellHook" | Write-Host
      "##vso[task.prependpath]$env:CONDA\Scripts" | Write-Host
    displayName: Prepare shell environment for Conda

  ##
  # Create and prepare conda environment
  ##
  - pwsh: |
      "##[info]Conda environment variables" | Write-Host
      Get-ChildItem env:CONDA*, env:*VERSION | Format-Table | Out-String | Write-Host

      "##[info]Creating conda environment" | Write-Host
      conda create --yes --name $(CondaEnvironmentName)

      "##[info]Installing conda packages" | Write-Host
      conda install --yes --name $(CondaEnvironmentName) python=3.9 pip conda-build=3.21.9 conda-package-handling=1.8.1
    displayName: Create and setup conda environment

  - pwsh: |
      "##[info]Activating conda environment:  $(CondaEnvironmentName)" | Write-Host
      $(CondaShellHook)
      conda activate $(CondaEnvironmentName)
      conda info

      $requirements = Join-Path 'src' 'Python' 'requirements.txt'
      "##[info]Install requirements from: $requirements" | Write-Host
      pip install -r $requirements
    displayName: Install PyPI packages

- job: "prototype_windows"
  variables:
    CondaEnvironmentName: conda_env
    CondaPath: C:\Miniconda3\Scripts
  pool: 
    vmImage: 'windows-latest'
  container: 'mcr.microsoft.com/quantum/windows-selfcontained:latest'
  steps:
  - task: UseDotNet@2
    displayName: 'Use .NET SDK'
    inputs:
      packageType: sdk
      useGlobalJson: true

  - task: UsePythonVersion@0
    inputs:
      versionSpec: 3.9
    displayName: 'Use Python 3.9'

  - pwsh: |
      $env:PATH="$env:CondaPath;$env:PATH"
      $CondaLocation=$(Get-Command conda | Select-Object -ExpandProperty Source)
      $CondaShellHook="(`& `$(Get-Command conda | Select-Object -ExpandProperty Source) 'shell.powershell' 'hook') | Out-String | Invoke-Expression"
      
      "##vso[task.setvariable variable=CondaEnvironmentName]conda_env" | Write-Host
      "##vso[task.setvariable variable=CondaLocation]$CondaLocation" | Write-Host
      "##vso[task.setvariable variable=CondaShellHook]$CondaShellHook" | Write-Host
      "##vso[task.prependpath]$env:CONDA\Scripts" | Write-Host
    displayName: Prepare shell environment for Conda

  ##
  # Create and prepare conda environment
  ##
  - pwsh: |
      "##[info]Conda environment variables" | Write-Host
      Get-ChildItem env:CONDA*, env:*VERSION | Format-Table | Out-String | Write-Host

      "##[info]Creating conda environment" | Write-Host
      conda create --yes --name $(CondaEnvironmentName)

      "##[info]Installing conda packages" | Write-Host
      conda install --yes --name $(CondaEnvironmentName) python=3.9 pip conda-build=3.21.9 conda-package-handling=1.8.1
    displayName: Create and setup conda environment

  - pwsh: |
      "##[info]Activating conda environment:  $(CondaEnvironmentName)" | Write-Host
      $(CondaShellHook)
      conda activate $(CondaEnvironmentName)
      conda info

      $requirements = Join-Path 'src' 'Python' 'requirements.txt'
      "##[info]Install requirements from: $requirements" | Write-Host
      pip install -r $requirements
    displayName: Install PyPI packages


- job: "iqsharp"
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - template: steps.yml
  - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
    displayName: 'Component Detection'
    inputs:
      failOnAlert: true

- job: "test_selenium"
  pool:
    vmImage: 'windows-2019'
  steps:
  - template: steps-selenium.yml
  condition: ne(variables['Skip.Tests'], 'true')

- job: "pack_selfcontained"
  dependsOn: "iqsharp"
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - template: steps-selfcontained.yml
  condition: ne(variables['Enable.Conda'], 'false')

- job: "pack_conda_macos"
  dependsOn: "pack_selfcontained"
  condition: and(succeeded(), ne(variables['Enable.Conda'], 'false'))
  pool:
    vmImage: 'macOS-latest'
  steps:
  - template: steps-conda.yml
  
- job: "pack_conda_linux"
  dependsOn: "pack_selfcontained"
  condition: and(succeeded(), ne(variables['Enable.Conda'], 'false'))
  pool:
    vmImage: 'ubuntu-latest'
  container: 'mcr.microsoft.com/quantum/linux-selfcontained:latest'
  steps:
  - template: steps-conda.yml
  
- job: "pack_conda_windows"
  dependsOn: "pack_selfcontained"
  condition: and(succeeded(), ne(variables['Enable.Conda'], 'false'))
  pool:
    vmImage: 'windows-latest'
  container: 'mcr.microsoft.com/quantum/windows-selfcontained:latest'
  steps:
  - template: steps-conda.yml
