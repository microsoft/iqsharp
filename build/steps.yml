##
# Build, test and pack the simulation framework.
##
parameters:
  enableTelemetry: "false"

steps:
- ${{ if eq(parameters.enableTelemetry, 'true') }}:
  - powershell: |
      echo "##vso[task.setvariable variable=IQSharp.Constants]TELEMETRY"
    displayName: 'Enable telemetry'

- ${{ if ne(parameters.enableTelemetry, 'true') }}:
  - powershell: |
      echo "##vso[task.setvariable variable=IQSharp.Constants]"
    displayName: 'Disable telemetry'

- task: PowerShell@2
  inputs:
    filePath: Update-VersionNumber.ps1
  displayName: "Set version number."

- task: DotNetCoreCLI@2
  displayName: 'Build IQ#'
  inputs:
    command: build
    arguments: >
      -c $(BuildConfiguration)
      -v $(Build.Verbosity)
      /p:DefineConstants="$(Assembly.Constants)$(Semicolon)$(IQSharp.Constants)"
      /p:Version=$(Assembly.Version)
    projects: '$(IQSharp.SourceDir)/iqsharp.sln'


- task: DotNetCoreCLI@2
  displayName: 'Pack IQ#'
  inputs:
    command: custom
    custom: pack
    projects: |
      $(IQSharp.SourceDir)/src/Tool/Tool.csproj
      $(IQSharp.SourceDir)/src/Core/Core.csproj
    arguments: >
      --no-build
      -c $(BuildConfiguration)
      -v n
      -o $(Nuget.OutDir)
      /p:Version=$(Assembly.Version)
      /p:PackageVersion=$(Nuget.Version)


- task: DotNetCoreCLI@2
  displayName: 'Test IQ#'
  condition: and(succeeded(), ne(variables['Skip.Tests'], 'true'))
  inputs:
    command: test
    arguments: >
      -c $(BuildConfiguration
      -v $(Build.Verbosity)
      /p:DefineConstants="$(Assembly.Constants)$(Semicolon)$(IQSharp.Constants)"
      /p:Version=$(Assembly.Version)
    projects: '$(IQSharp.SourceDir)/iqsharp.sln'
