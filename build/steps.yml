##
# Build and test IQ#.
##

steps:

##
# Pre-reqs
##
- task: UseDotNet@2
  displayName: 'Use .NET SDK'
  inputs:
    packageType: sdk
    useGlobalJson: true

- task: UsePythonVersion@0
  inputs:
    versionSpec: 3.7
  displayName: 'Use Python 3.7'

- pwsh: .\bootstrap.ps1
  displayName: "Bootstrap"
  workingDirectory: '$(System.DefaultWorkingDirectory)'


- task: CondaEnvironment@1
  inputs:
    packageSpecs: "python=3.7 pip setuptools pytest jupyter numpy"
  displayName: 'Use conda environment w/ Python 3.'

- pwsh: |
    pip install `
      setuptools `
      pytest `
      jupyter `
      numpy `
      wheel `
      qutip
  displayName: "Install Python tools."

##
# Build, test & pack
##
- pwsh: .\build.ps1
  displayName: "Building IQ#"
  workingDirectory: '$(System.DefaultWorkingDirectory)/build'
  
- pwsh: .\test.ps1
  displayName: "Testing IQ#"
  workingDirectory: '$(System.DefaultWorkingDirectory)/build'
  condition: and(succeeded(), ne(variables['Skip.Tests'], 'true'))

- pwsh: .\pack.ps1
  displayName: "Packing IQ#"
  workingDirectory: '$(System.DefaultWorkingDirectory)/build'

- pwsh: .\manifest.ps1
  displayName: "List built packages & assemblies"
  workingDirectory: '$(System.DefaultWorkingDirectory)/build'
  condition: succeededOrFailed()

##
# Publish tests results and build artifacts.
##
- task: PublishTestResults@2
  displayName: 'Publish IQ# tests results'
  condition: succeededOrFailed()
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: '$(System.DefaultWorkingDirectory)/**/*.trx'
    testRunTitle: 'IQ# tests'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: iqsharp'
  condition: succeededOrFailed()
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: iqsharp
